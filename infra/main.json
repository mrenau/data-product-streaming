{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.12.40.16777",
      "templateHash": "17358088311522229630"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "metadata": {
        "description": "Specifies the location for all resources."
      }
    },
    "environment": {
      "type": "string",
      "metadata": {
        "description": "Specifies the environment of the deployment."
      },
      "allowedValues": [
        "dev",
        "tst",
        "prd"
      ]
    },
    "prefix": {
      "type": "string",
      "metadata": {
        "description": "Specifies the prefix for all resources created in this deployment."
      },
      "maxLength": 10,
      "minLength": 2
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Specifies the tags that you want to apply to all resources."
      }
    },
    "administratorPassword": {
      "type": "secureString",
      "metadata": {
        "description": "Specifies the administrator password of the sql servers."
      }
    },
    "synapseDefaultStorageAccountFileSystemId": {
      "type": "string",
      "metadata": {
        "description": "Specifies the resource ID of the default storage account file system for synapse."
      }
    },
    "enableSqlPool": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Specifies whether an Azure SQL Pool should be deployed inside your Synapse workspace as part of the template. If you selected dataFactory as processingService, leave this value as is."
      }
    },
    "enableDataExplorerPool": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Specifies whether an Azure Data Explorer Pool should be deployed inside your Synapse workspace as part of the template. If you selected dataFactory as processingService, leave this value as is."
      }
    },
    "enableSqlServer": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Specifies whether Azure SQL Server should be deployed as part of the template."
      }
    },
    "enableCosmos": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Specifies whether Azure Cosmos DB should be deployed as part of the template."
      }
    },
    "enableStreamAnalytics": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Specifies whether Azure Stream Analytics Cluster and Job should be deployed as part of the template."
      }
    },
    "streamanalyticsDefaultStorageAccountFileSystemId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Specifies the resource ID of the default storage account  file system for stream analytics."
      }
    },
    "purviewId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Specifies the resource ID of the central purview instance."
      }
    },
    "enableRoleAssignments": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Specifies whether role assignments should be enabled."
      }
    },
    "enableMonitoring": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Specifies whether observability capabilities should be enabled."
      }
    },
    "dataProductTeamEmail": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Specifies the email address of the Data Product SRE team."
      }
    },
    "subnetId": {
      "type": "string",
      "metadata": {
        "description": "Specifies the resource ID of the subnet to which all services will connect."
      }
    },
    "privateDnsZoneIdKeyVault": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Specifies the resource ID of the private DNS zone for KeyVault."
      }
    },
    "privateDnsZoneIdSynapseDev": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Specifies the resource ID of the private DNS zone for Synapse Dev."
      }
    },
    "privateDnsZoneIdSynapseSql": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Specifies the resource ID of the private DNS zone for Synapse Sql."
      }
    },
    "privateDnsZoneIdEventhubNamespace": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Specifies the resource ID of the private DNS zone for EventHub Namespaces."
      }
    },
    "privateDnsZoneIdCosmosdbSql": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Specifies the resource ID of the private DNS zone for Cosmos Sql."
      }
    },
    "privateDnsZoneIdSqlServer": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Specifies the resource ID of the private DNS zone for Sql Server."
      }
    },
    "privateDnsZoneIdIothub": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Specifies the resource ID of the private DNS zone for IoT Hub."
      }
    }
  },
  "variables": {
    "name": "[toLower(format('{0}-{1}', parameters('prefix'), parameters('environment')))]",
    "tagsDefault": {
      "Owner": "Data Management and Analytics Scenario",
      "Project": "Data Management and Analytics Scenario",
      "Environment": "[parameters('environment')]",
      "Toolkit": "bicep",
      "Name": "[variables('name')]"
    },
    "tagsJoined": "[union(variables('tagsDefault'), parameters('tags'))]",
    "administratorUsername": "SqlServerMainUser",
    "synapseDefaultStorageAccountSubscriptionId": "[if(greaterOrEquals(length(split(parameters('synapseDefaultStorageAccountFileSystemId'), '/')), 13), split(parameters('synapseDefaultStorageAccountFileSystemId'), '/')[2], subscription().subscriptionId)]",
    "synapseDefaultStorageAccountResourceGroupName": "[if(greaterOrEquals(length(split(parameters('synapseDefaultStorageAccountFileSystemId'), '/')), 13), split(parameters('synapseDefaultStorageAccountFileSystemId'), '/')[4], resourceGroup().name)]",
    "streamanalyticsDefaultStorageAccountSubscriptionId": "[if(greaterOrEquals(length(split(parameters('streamanalyticsDefaultStorageAccountFileSystemId'), '/')), 13), split(parameters('streamanalyticsDefaultStorageAccountFileSystemId'), '/')[2], subscription().subscriptionId)]",
    "streamanalyticsDefaultStorageAccountResourceGroupName": "[if(greaterOrEquals(length(split(parameters('streamanalyticsDefaultStorageAccountFileSystemId'), '/')), 13), split(parameters('streamanalyticsDefaultStorageAccountFileSystemId'), '/')[4], resourceGroup().name)]",
    "streamanalyticsDefaultStorageAccountName": "[if(greaterOrEquals(length(split(parameters('streamanalyticsDefaultStorageAccountFileSystemId'), '/')), 13), split(parameters('streamanalyticsDefaultStorageAccountFileSystemId'), '/')[8], 'incorrectSegmentLength')]",
    "keyVault001Name": "[format('{0}-vault001', variables('name'))]",
    "synapse001Name": "[format('{0}-synapse001', variables('name'))]",
    "cosmosdb001Name": "[format('{0}-cosmos001', variables('name'))]",
    "sql001Name": "[format('{0}-sqlserver001', variables('name'))]",
    "iothub001Name": "[format('{0}-iothub001', variables('name'))]",
    "eventhubNamespace001Name": "[format('{0}-eventhub001', variables('name'))]",
    "streamanalytics001Name": "[format('{0}-streamanalytics001', variables('name'))]",
    "streamanalyticscluster001Name": "[format('{0}-streamanalyticscluster001', variables('name'))]",
    "logAnalytics001Name": "[format('{0}-loganalytics001', variables('name'))]",
    "dataEmailActionGroup": "[format('{0}-emailactiongroup', variables('name'))]",
    "synapsePipelineFailedAlertName": "[format('{0}-failedalert', variables('synapse001Name'))]",
    "iothubFailedAlertName": "[format('{0}-failedalert', variables('iothub001Name'))]",
    "eventhubnamespaceFailedAlertName": "[format('{0}-failedalert', variables('eventhubNamespace001Name'))]",
    "streamanalyticsFailedAlertName": "[format('{0}-failedalert', variables('streamanalytics001Name'))]",
    "dashboardName": "[format('{0}-dashboard', variables('name'))]",
    "database001Name": "Database001"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "keyVault001",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "keyvaultName": {
            "value": "[variables('keyVault001Name')]"
          },
          "tags": {
            "value": "[variables('tagsJoined')]"
          },
          "subnetId": {
            "value": "[parameters('subnetId')]"
          },
          "privateDnsZoneIdKeyVault": {
            "value": "[parameters('privateDnsZoneIdKeyVault')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.12.40.16777",
              "templateHash": "15797637048712885311"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "subnetId": {
              "type": "string"
            },
            "keyvaultName": {
              "type": "string"
            },
            "privateDnsZoneIdKeyVault": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "variables": {
            "keyVaultPrivateEndpointName": "[format('{0}-private-endpoint', parameters('keyvaultName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2021-04-01-preview",
              "name": "[parameters('keyvaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "accessPolicies": [],
                "createMode": "default",
                "enabledForDeployment": false,
                "enabledForDiskEncryption": false,
                "enabledForTemplateDeployment": false,
                "enablePurgeProtection": true,
                "enableRbacAuthorization": true,
                "enableSoftDelete": true,
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "Deny",
                  "ipRules": [],
                  "virtualNetworkRules": []
                },
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "softDeleteRetentionInDays": 7,
                "tenantId": "[subscription().tenantId]"
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2020-11-01",
              "name": "[variables('keyVaultPrivateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "manualPrivateLinkServiceConnections": [],
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('keyVaultPrivateEndpointName')]",
                    "properties": {
                      "groupIds": [
                        "vault"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyvaultName'))]",
                      "requestMessage": ""
                    }
                  }
                ],
                "subnet": {
                  "id": "[parameters('subnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyvaultName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('privateDnsZoneIdKeyVault')))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2020-11-01",
              "name": "[format('{0}/{1}', variables('keyVaultPrivateEndpointName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[format('{0}-arecord', variables('keyVaultPrivateEndpointName'))]",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneIdKeyVault')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('keyVaultPrivateEndpointName'))]"
              ]
            }
          ],
          "outputs": {
            "keyvaultId": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyvaultName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "synapse001",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "synapseName": {
            "value": "[variables('synapse001Name')]"
          },
          "tags": {
            "value": "[variables('tagsJoined')]"
          },
          "subnetId": {
            "value": "[parameters('subnetId')]"
          },
          "administratorUsername": {
            "value": "[variables('administratorUsername')]"
          },
          "administratorPassword": {
            "value": "[parameters('administratorPassword')]"
          },
          "synapseSqlAdminGroupName": {
            "value": ""
          },
          "synapseSqlAdminGroupObjectID": {
            "value": ""
          },
          "privateDnsZoneIdSynapseDev": {
            "value": "[parameters('privateDnsZoneIdSynapseDev')]"
          },
          "privateDnsZoneIdSynapseSql": {
            "value": "[parameters('privateDnsZoneIdSynapseSql')]"
          },
          "purviewId": {
            "value": "[parameters('purviewId')]"
          },
          "enableDataExplorerPool": {
            "value": "[parameters('enableDataExplorerPool')]"
          },
          "enableSqlPool": {
            "value": "[parameters('enableSqlPool')]"
          },
          "synapseComputeSubnetId": {
            "value": ""
          },
          "synapseDefaultStorageAccountFileSystemId": {
            "value": "[parameters('synapseDefaultStorageAccountFileSystemId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.12.40.16777",
              "templateHash": "11586303874459389276"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "subnetId": {
              "type": "string"
            },
            "synapseName": {
              "type": "string"
            },
            "administratorUsername": {
              "type": "string",
              "defaultValue": "SqlServerMainUser"
            },
            "administratorPassword": {
              "type": "secureString"
            },
            "synapseSqlAdminGroupName": {
              "type": "string",
              "defaultValue": ""
            },
            "synapseSqlAdminGroupObjectID": {
              "type": "string",
              "defaultValue": ""
            },
            "synapseDefaultStorageAccountFileSystemId": {
              "type": "string"
            },
            "synapseComputeSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "privateDnsZoneIdSynapseSql": {
              "type": "string",
              "defaultValue": ""
            },
            "privateDnsZoneIdSynapseDev": {
              "type": "string",
              "defaultValue": ""
            },
            "purviewId": {
              "type": "string",
              "defaultValue": ""
            },
            "enableDataExplorerPool": {
              "type": "bool",
              "defaultValue": false
            },
            "enableSqlPool": {
              "type": "bool",
              "defaultValue": false
            }
          },
          "variables": {
            "synapseDefaultStorageAccountFileSystemName": "[if(greaterOrEquals(length(split(parameters('synapseDefaultStorageAccountFileSystemId'), '/')), 13), last(split(parameters('synapseDefaultStorageAccountFileSystemId'), '/')), 'incorrectSegmentLength')]",
            "synapseDefaultStorageAccountName": "[if(greaterOrEquals(length(split(parameters('synapseDefaultStorageAccountFileSystemId'), '/')), 13), split(parameters('synapseDefaultStorageAccountFileSystemId'), '/')[8], 'incorrectSegmentLength')]",
            "synapsePrivateEndpointNameSql": "[format('{0}-sql-private-endpoint', parameters('synapseName'))]",
            "synapsePrivateEndpointNameSqlOnDemand": "[format('{0}-sqlondemand-private-endpoint', parameters('synapseName'))]",
            "synapsePrivateEndpointNameDev": "[format('{0}-dev-private-endpoint', parameters('synapseName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Synapse/workspaces",
              "apiVersion": "2021-06-01",
              "name": "[parameters('synapseName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "defaultDataLakeStorage": {
                  "accountUrl": "[format('https://{0}.dfs.{1}', variables('synapseDefaultStorageAccountName'), environment().suffixes.storage)]",
                  "filesystem": "[variables('synapseDefaultStorageAccountFileSystemName')]"
                },
                "managedResourceGroupName": "[parameters('synapseName')]",
                "managedVirtualNetwork": "default",
                "managedVirtualNetworkSettings": {
                  "allowedAadTenantIdsForLinking": [],
                  "linkedAccessCheckOnTargetResource": true,
                  "preventDataExfiltration": true
                },
                "publicNetworkAccess": "Disabled",
                "purviewConfiguration": "[if(empty(parameters('purviewId')), createObject(), createObject('purviewResourceId', parameters('purviewId')))]",
                "sqlAdministratorLogin": "[parameters('administratorUsername')]",
                "sqlAdministratorLoginPassword": "[parameters('administratorPassword')]",
                "virtualNetworkProfile": {
                  "computeSubnetId": "[parameters('synapseComputeSubnetId')]"
                }
              }
            },
            {
              "condition": "[parameters('enableSqlPool')]",
              "type": "Microsoft.Synapse/workspaces/sqlPools",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}', parameters('synapseName'), 'sqlPool001')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "DW100c"
              },
              "properties": {
                "collation": "SQL_Latin1_General_CP1_CI_AS",
                "createMode": "Default",
                "storageAccountType": "GRS"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Synapse/workspaces', parameters('synapseName'))]"
              ]
            },
            {
              "condition": "[parameters('enableDataExplorerPool')]",
              "type": "Microsoft.Synapse/workspaces/kustoPools",
              "apiVersion": "2021-06-01-preview",
              "name": "[format('{0}/{1}', parameters('synapseName'), 'dataexplorerpool001')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Compute optimized",
                "size": "Extra small"
              },
              "properties": {
                "enablePurge": true,
                "enableStreamingIngest": true,
                "optimizedAutoscale": {
                  "isEnabled": true,
                  "version": 1,
                  "minimum": 2,
                  "maximum": 4
                },
                "workspaceUID": "[reference(resourceId('Microsoft.Synapse/workspaces', parameters('synapseName')), '2021-06-01').workspaceUID]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Synapse/workspaces', parameters('synapseName'))]"
              ]
            },
            {
              "type": "Microsoft.Synapse/workspaces/bigDataPools",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}', parameters('synapseName'), 'bigDataPool001')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "autoPause": {
                  "enabled": true,
                  "delayInMinutes": 15
                },
                "autoScale": {
                  "enabled": true,
                  "minNodeCount": 3,
                  "maxNodeCount": 10
                },
                "customLibraries": [],
                "defaultSparkLogFolder": "logs/",
                "dynamicExecutorAllocation": {
                  "enabled": true,
                  "minExecutors": 1,
                  "maxExecutors": 9
                },
                "nodeSize": "Small",
                "nodeSizeFamily": "MemoryOptimized",
                "sessionLevelPackagesEnabled": true,
                "sparkEventsFolder": "events/",
                "sparkVersion": "3.1"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Synapse/workspaces', parameters('synapseName'))]"
              ]
            },
            {
              "type": "Microsoft.Synapse/workspaces/managedIdentitySqlControlSettings",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}', parameters('synapseName'), 'default')]",
              "properties": {
                "grantSqlControlToManagedIdentity": {
                  "desiredState": "Enabled"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Synapse/workspaces', parameters('synapseName'))]"
              ]
            },
            {
              "condition": "[and(not(empty(parameters('synapseSqlAdminGroupName'))), not(empty(parameters('synapseSqlAdminGroupObjectID'))))]",
              "type": "Microsoft.Synapse/workspaces/administrators",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}', parameters('synapseName'), 'activeDirectory')]",
              "properties": {
                "administratorType": "ActiveDirectory",
                "login": "[parameters('synapseSqlAdminGroupName')]",
                "sid": "[parameters('synapseSqlAdminGroupObjectID')]",
                "tenantId": "[subscription().tenantId]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Synapse/workspaces', parameters('synapseName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2020-11-01",
              "name": "[variables('synapsePrivateEndpointNameSql')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "manualPrivateLinkServiceConnections": [],
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('synapsePrivateEndpointNameSql')]",
                    "properties": {
                      "groupIds": [
                        "Sql"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.Synapse/workspaces', parameters('synapseName'))]",
                      "requestMessage": ""
                    }
                  }
                ],
                "subnet": {
                  "id": "[parameters('subnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Synapse/workspaces', parameters('synapseName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('privateDnsZoneIdSynapseSql')))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2020-11-01",
              "name": "[format('{0}/{1}', variables('synapsePrivateEndpointNameSql'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[format('{0}-arecord', variables('synapsePrivateEndpointNameSql'))]",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneIdSynapseSql')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('synapsePrivateEndpointNameSql'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2020-11-01",
              "name": "[variables('synapsePrivateEndpointNameSqlOnDemand')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "manualPrivateLinkServiceConnections": [],
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('synapsePrivateEndpointNameSqlOnDemand')]",
                    "properties": {
                      "groupIds": [
                        "SqlOnDemand"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.Synapse/workspaces', parameters('synapseName'))]",
                      "requestMessage": ""
                    }
                  }
                ],
                "subnet": {
                  "id": "[parameters('subnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Synapse/workspaces', parameters('synapseName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('privateDnsZoneIdSynapseSql')))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2020-11-01",
              "name": "[format('{0}/{1}', variables('synapsePrivateEndpointNameSqlOnDemand'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[format('{0}-arecord', variables('synapsePrivateEndpointNameSqlOnDemand'))]",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneIdSynapseSql')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('synapsePrivateEndpointNameSqlOnDemand'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2020-11-01",
              "name": "[variables('synapsePrivateEndpointNameDev')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "manualPrivateLinkServiceConnections": [],
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('synapsePrivateEndpointNameDev')]",
                    "properties": {
                      "groupIds": [
                        "Dev"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.Synapse/workspaces', parameters('synapseName'))]",
                      "requestMessage": ""
                    }
                  }
                ],
                "subnet": {
                  "id": "[parameters('subnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Synapse/workspaces', parameters('synapseName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('privateDnsZoneIdSynapseDev')))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2020-11-01",
              "name": "[format('{0}/{1}', variables('synapsePrivateEndpointNameDev'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[format('{0}-arecord', variables('synapsePrivateEndpointNameDev'))]",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneIdSynapseDev')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('synapsePrivateEndpointNameDev'))]"
              ]
            }
          ],
          "outputs": {
            "synapseId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Synapse/workspaces', parameters('synapseName'))]"
            },
            "synapseName": {
              "type": "string",
              "value": "[parameters('synapseName')]"
            },
            "synapseBigDataPool001Name": {
              "type": "string",
              "value": "bigDataPool001"
            },
            "synapseSqlPool001Name": {
              "type": "string",
              "value": "sqlPool001"
            }
          }
        }
      }
    },
    {
      "condition": "[parameters('enableRoleAssignments')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "synapse001RoleAssignmentStorage",
      "subscriptionId": "[variables('synapseDefaultStorageAccountSubscriptionId')]",
      "resourceGroup": "[variables('synapseDefaultStorageAccountResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountFileSystemId": {
            "value": "[parameters('synapseDefaultStorageAccountFileSystemId')]"
          },
          "synapseId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'synapse001'), '2020-10-01').outputs.synapseId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.12.40.16777",
              "templateHash": "13602656477775353919"
            }
          },
          "parameters": {
            "storageAccountFileSystemId": {
              "type": "string"
            },
            "synapseId": {
              "type": "string"
            }
          },
          "variables": {
            "storageAccountFileSystemName": "[if(greaterOrEquals(length(split(parameters('storageAccountFileSystemId'), '/')), 13), last(split(parameters('storageAccountFileSystemId'), '/')), 'incorrectSegmentLength')]",
            "storageAccountName": "[if(greaterOrEquals(length(split(parameters('storageAccountFileSystemId'), '/')), 13), split(parameters('storageAccountFileSystemId'), '/')[8], 'incorrectSegmentLength')]",
            "synapseSubscriptionId": "[if(greaterOrEquals(length(split(parameters('synapseId'), '/')), 9), split(parameters('synapseId'), '/')[2], subscription().subscriptionId)]",
            "synapseResourceGroupName": "[if(greaterOrEquals(length(split(parameters('synapseId'), '/')), 9), split(parameters('synapseId'), '/')[4], resourceGroup().name)]",
            "synapseName": "[if(greaterOrEquals(length(split(parameters('synapseId'), '/')), 9), last(split(parameters('synapseId'), '/')), 'incorrectSegmentLength')]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}/blobServices/{1}/containers/{2}', split(format('{0}/default/{1}', variables('storageAccountName'), variables('storageAccountFileSystemName')), '/')[0], split(format('{0}/default/{1}', variables('storageAccountName'), variables('storageAccountFileSystemName')), '/')[1], split(format('{0}/default/{1}', variables('storageAccountName'), variables('storageAccountFileSystemName')), '/')[2])]",
              "name": "[guid(uniqueString(resourceId('Microsoft.Storage/storageAccounts/blobServices/containers', split(format('{0}/default/{1}', variables('storageAccountName'), variables('storageAccountFileSystemName')), '/')[0], split(format('{0}/default/{1}', variables('storageAccountName'), variables('storageAccountFileSystemName')), '/')[1], split(format('{0}/default/{1}', variables('storageAccountName'), variables('storageAccountFileSystemName')), '/')[2]), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('synapseSubscriptionId'), variables('synapseResourceGroupName')), 'Microsoft.Synapse/workspaces', variables('synapseName'))))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                "principalId": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('synapseSubscriptionId'), variables('synapseResourceGroupName')), 'Microsoft.Synapse/workspaces', variables('synapseName')), '2021-03-01', 'full').identity.principalId]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'synapse001')]"
      ]
    },
    {
      "condition": "[parameters('enableCosmos')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "cosmos001",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "cosmosdbName": {
            "value": "[variables('cosmosdb001Name')]"
          },
          "tags": {
            "value": "[variables('tagsJoined')]"
          },
          "subnetId": {
            "value": "[parameters('subnetId')]"
          },
          "privateDnsZoneIdCosmosdbSql": {
            "value": "[parameters('privateDnsZoneIdCosmosdbSql')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.12.40.16777",
              "templateHash": "12746317022903297568"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "subnetId": {
              "type": "string"
            },
            "cosmosdbName": {
              "type": "string"
            },
            "privateDnsZoneIdCosmosdbSql": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "variables": {
            "cosmosdbPrivateEndpointName": "[format('{0}-private-endpoint', parameters('cosmosdbName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2021-03-15",
              "name": "[parameters('cosmosdbName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "kind": "GlobalDocumentDB",
              "properties": {
                "backupPolicy": {
                  "type": "Continuous"
                },
                "capabilities": [],
                "consistencyPolicy": {
                  "defaultConsistencyLevel": "Eventual",
                  "maxStalenessPrefix": 1,
                  "maxIntervalInSeconds": 5
                },
                "cors": [],
                "databaseAccountOfferType": "Standard",
                "disableKeyBasedMetadataWriteAccess": true,
                "enableAnalyticalStorage": false,
                "enableAutomaticFailover": true,
                "enableCassandraConnector": false,
                "enableFreeTier": false,
                "enableMultipleWriteLocations": false,
                "ipRules": [],
                "networkAclBypass": "None",
                "networkAclBypassResourceIds": [],
                "publicNetworkAccess": "Disabled",
                "virtualNetworkRules": [],
                "isVirtualNetworkFilterEnabled": true,
                "locations": [
                  {
                    "locationName": "[parameters('location')]",
                    "failoverPriority": 0,
                    "isZoneRedundant": false
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2020-11-01",
              "name": "[variables('cosmosdbPrivateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "manualPrivateLinkServiceConnections": [],
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('cosmosdbPrivateEndpointName')]",
                    "properties": {
                      "groupIds": [
                        "sql"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosdbName'))]",
                      "requestMessage": ""
                    }
                  }
                ],
                "subnet": {
                  "id": "[parameters('subnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosdbName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('privateDnsZoneIdCosmosdbSql')))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2020-11-01",
              "name": "[format('{0}/{1}', variables('cosmosdbPrivateEndpointName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[format('{0}-arecord', variables('cosmosdbPrivateEndpointName'))]",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneIdCosmosdbSql')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('cosmosdbPrivateEndpointName'))]"
              ]
            }
          ],
          "outputs": {
            "cosmosdbId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosdbName'))]"
            },
            "cosmosdbName": {
              "type": "string",
              "value": "[parameters('cosmosdbName')]"
            }
          }
        }
      }
    },
    {
      "condition": "[parameters('enableSqlServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "sql001",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "sqlserverName": {
            "value": "[variables('sql001Name')]"
          },
          "tags": {
            "value": "[variables('tagsJoined')]"
          },
          "subnetId": {
            "value": "[parameters('subnetId')]"
          },
          "administratorUsername": {
            "value": "[variables('administratorUsername')]"
          },
          "administratorPassword": {
            "value": "[parameters('administratorPassword')]"
          },
          "privateDnsZoneIdSqlServer": {
            "value": "[parameters('privateDnsZoneIdSqlServer')]"
          },
          "sqlserverAdminGroupName": {
            "value": ""
          },
          "sqlserverAdminGroupObjectID": {
            "value": ""
          },
          "database001Name": {
            "value": "[variables('database001Name')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.12.40.16777",
              "templateHash": "15749355047454176097"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "subnetId": {
              "type": "string"
            },
            "sqlserverName": {
              "type": "string"
            },
            "database001Name": {
              "type": "string"
            },
            "administratorUsername": {
              "type": "string",
              "defaultValue": "SqlServerMainUser"
            },
            "administratorPassword": {
              "type": "secureString"
            },
            "sqlserverAdminGroupName": {
              "type": "string",
              "defaultValue": ""
            },
            "sqlserverAdminGroupObjectID": {
              "type": "string",
              "defaultValue": ""
            },
            "privateDnsZoneIdSqlServer": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "variables": {
            "sqlserverPrivateEndpointName": "[format('{0}-private-endpoint', parameters('sqlserverName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Sql/servers",
              "apiVersion": "2020-11-01-preview",
              "name": "[parameters('sqlserverName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "administratorLogin": "[parameters('administratorUsername')]",
                "administratorLoginPassword": "[parameters('administratorPassword')]",
                "administrators": {},
                "minimalTlsVersion": "1.2",
                "publicNetworkAccess": "Disabled",
                "version": "12.0"
              }
            },
            {
              "condition": "[and(not(empty(parameters('sqlserverAdminGroupName'))), not(empty(parameters('sqlserverAdminGroupObjectID'))))]",
              "type": "Microsoft.Sql/servers/administrators",
              "apiVersion": "2020-11-01-preview",
              "name": "[format('{0}/{1}', parameters('sqlserverName'), 'ActiveDirectory')]",
              "properties": {
                "administratorType": "ActiveDirectory",
                "login": "[parameters('sqlserverAdminGroupName')]",
                "sid": "[parameters('sqlserverAdminGroupObjectID')]",
                "tenantId": "[subscription().tenantId]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('sqlserverName'))]"
              ]
            },
            {
              "type": "Microsoft.Sql/servers/databases",
              "apiVersion": "2020-11-01-preview",
              "name": "[format('{0}/{1}', parameters('sqlserverName'), parameters('database001Name'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Basic",
                "tier": "Basic",
                "capacity": 5
              },
              "properties": {
                "autoPauseDelay": -1,
                "catalogCollation": "DATABASE_DEFAULT",
                "collation": "SQL_Latin1_General_CP1_CI_AS",
                "createMode": "Default",
                "readScale": "Disabled",
                "highAvailabilityReplicaCount": 0,
                "licenseType": "LicenseIncluded",
                "maxSizeBytes": 524288000,
                "minCapacity": 1,
                "requestedBackupStorageRedundancy": "Geo",
                "zoneRedundant": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('sqlserverName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2020-11-01",
              "name": "[variables('sqlserverPrivateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "manualPrivateLinkServiceConnections": [],
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('sqlserverPrivateEndpointName')]",
                    "properties": {
                      "groupIds": [
                        "sqlServer"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.Sql/servers', parameters('sqlserverName'))]",
                      "requestMessage": ""
                    }
                  }
                ],
                "subnet": {
                  "id": "[parameters('subnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('sqlserverName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('privateDnsZoneIdSqlServer')))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2020-11-01",
              "name": "[format('{0}/{1}', variables('sqlserverPrivateEndpointName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[format('{0}-arecord', variables('sqlserverPrivateEndpointName'))]",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneIdSqlServer')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('sqlserverPrivateEndpointName'))]"
              ]
            }
          ],
          "outputs": {
            "sqlserverId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Sql/servers', parameters('sqlserverName'))]"
            },
            "sqlserverDatabaseId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Sql/servers/databases', parameters('sqlserverName'), parameters('database001Name'))]"
            },
            "sqlserverDatabaseName": {
              "type": "string",
              "value": "[parameters('database001Name')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "iothub001",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "iothubName": {
            "value": "[variables('iothub001Name')]"
          },
          "tags": {
            "value": "[variables('tagsJoined')]"
          },
          "subnetId": {
            "value": "[parameters('subnetId')]"
          },
          "iothubSkuName": {
            "value": "S1"
          },
          "iothubSkuCapacity": {
            "value": 1
          },
          "privateDnsZoneIdEventhubNamespace": {
            "value": "[parameters('privateDnsZoneIdEventhubNamespace')]"
          },
          "privateDnsZoneIdIothub": {
            "value": "[parameters('privateDnsZoneIdIothub')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.12.40.16777",
              "templateHash": "17591850449907183936"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "subnetId": {
              "type": "string"
            },
            "iothubName": {
              "type": "string"
            },
            "iothubSkuName": {
              "type": "string",
              "defaultValue": "S1"
            },
            "iothubSkuCapacity": {
              "type": "int",
              "defaultValue": 1,
              "maxValue": 200,
              "minValue": 1
            },
            "privateDnsZoneIdIothub": {
              "type": "string",
              "defaultValue": ""
            },
            "privateDnsZoneIdEventhubNamespace": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "variables": {
            "iothubPrivateEndpointName": "[format('{0}-private-endpoint', parameters('iothubName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Devices/IotHubs",
              "apiVersion": "2021-03-31",
              "name": "[parameters('iothubName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "sku": {
                "name": "[parameters('iothubSkuName')]",
                "capacity": "[parameters('iothubSkuCapacity')]"
              },
              "properties": {
                "authorizationPolicies": [],
                "cloudToDevice": {
                  "defaultTtlAsIso8601": "PT1M",
                  "feedback": {
                    "lockDurationAsIso8601": "PT1M",
                    "maxDeliveryCount": 10,
                    "ttlAsIso8601": "PT1H"
                  },
                  "maxDeliveryCount": 10
                },
                "comments": "",
                "enableFileUploadNotifications": false,
                "eventHubEndpoints": {
                  "events": {
                    "partitionCount": 4,
                    "retentionTimeInDays": 1
                  }
                },
                "features": "DeviceManagement",
                "ipFilterRules": [],
                "messagingEndpoints": {
                  "fileNotifications": {
                    "lockDurationAsIso8601": "PT1M",
                    "maxDeliveryCount": 10,
                    "ttlAsIso8601": "PT1H"
                  }
                },
                "networkRuleSets": {
                  "applyToBuiltInEventHubEndpoint": true,
                  "defaultAction": "Deny",
                  "ipRules": []
                },
                "publicNetworkAccess": "Disabled",
                "routing": {
                  "endpoints": {
                    "eventHubs": [],
                    "serviceBusQueues": [],
                    "serviceBusTopics": [],
                    "storageContainers": []
                  },
                  "enrichments": [],
                  "fallbackRoute": {
                    "condition": "true",
                    "endpointNames": [
                      "events"
                    ],
                    "isEnabled": false,
                    "name": "$fallback",
                    "source": "DeviceMessages"
                  },
                  "routes": []
                },
                "storageEndpoints": {}
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2020-11-01",
              "name": "[variables('iothubPrivateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "manualPrivateLinkServiceConnections": [],
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('iothubPrivateEndpointName')]",
                    "properties": {
                      "groupIds": [
                        "iotHub"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.Devices/IotHubs', parameters('iothubName'))]",
                      "requestMessage": ""
                    }
                  }
                ],
                "subnet": {
                  "id": "[parameters('subnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Devices/IotHubs', parameters('iothubName'))]"
              ]
            },
            {
              "condition": "[and(not(empty(parameters('privateDnsZoneIdIothub'))), not(empty(parameters('privateDnsZoneIdEventhubNamespace'))))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2020-11-01",
              "name": "[format('{0}/{1}', variables('iothubPrivateEndpointName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[format('{0}-arecord-iothub', variables('iothubPrivateEndpointName'))]",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneIdIothub')]"
                    }
                  },
                  {
                    "name": "[format('{0}-arecord-eventhub', variables('iothubPrivateEndpointName'))]",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneIdEventhubNamespace')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('iothubPrivateEndpointName'))]"
              ]
            }
          ],
          "outputs": {
            "iothubId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Devices/IotHubs', parameters('iothubName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "eventhubNamespace001",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tagsJoined')]"
          },
          "subnetId": {
            "value": "[parameters('subnetId')]"
          },
          "eventhubnamespaceName": {
            "value": "[variables('eventhubNamespace001Name')]"
          },
          "privateDnsZoneIdEventhubNamespace": {
            "value": "[parameters('privateDnsZoneIdEventhubNamespace')]"
          },
          "eventhubnamespaceMinThroughput": {
            "value": 1
          },
          "eventhubnamespaceMaxThroughput": {
            "value": 1
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.12.40.16777",
              "templateHash": "14719186006568002366"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "subnetId": {
              "type": "string"
            },
            "eventhubnamespaceName": {
              "type": "string"
            },
            "eventhubnamespaceMinThroughput": {
              "type": "int",
              "maxValue": 20,
              "minValue": 1
            },
            "eventhubnamespaceMaxThroughput": {
              "type": "int",
              "maxValue": 20,
              "minValue": 1
            },
            "privateDnsZoneIdEventhubNamespace": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "variables": {
            "eventhubNamespacePrivateEndpointName": "[format('{0}-private-endpoint', parameters('eventhubnamespaceName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.EventHub/namespaces",
              "apiVersion": "2021-06-01-preview",
              "name": "[parameters('eventhubnamespaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "sku": {
                "name": "Standard",
                "tier": "Standard",
                "capacity": "[parameters('eventhubnamespaceMinThroughput')]"
              },
              "properties": {
                "disableLocalAuth": true,
                "isAutoInflateEnabled": true,
                "kafkaEnabled": true,
                "maximumThroughputUnits": "[parameters('eventhubnamespaceMaxThroughput')]",
                "zoneRedundant": true
              }
            },
            {
              "type": "Microsoft.EventHub/namespaces/networkRuleSets",
              "apiVersion": "2021-06-01-preview",
              "name": "[format('{0}/{1}', parameters('eventhubnamespaceName'), 'default')]",
              "properties": {
                "defaultAction": "Deny",
                "ipRules": [],
                "virtualNetworkRules": [],
                "publicNetworkAccess": "Disabled",
                "trustedServiceAccessEnabled": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.EventHub/namespaces', parameters('eventhubnamespaceName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2020-11-01",
              "name": "[variables('eventhubNamespacePrivateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "manualPrivateLinkServiceConnections": [],
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('eventhubNamespacePrivateEndpointName')]",
                    "properties": {
                      "groupIds": [
                        "namespace"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.EventHub/namespaces', parameters('eventhubnamespaceName'))]",
                      "requestMessage": ""
                    }
                  }
                ],
                "subnet": {
                  "id": "[parameters('subnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.EventHub/namespaces', parameters('eventhubnamespaceName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('privateDnsZoneIdEventhubNamespace')))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2020-11-01",
              "name": "[format('{0}/{1}', variables('eventhubNamespacePrivateEndpointName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[format('{0}-arecord', variables('eventhubNamespacePrivateEndpointName'))]",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneIdEventhubNamespace')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('eventhubNamespacePrivateEndpointName'))]"
              ]
            }
          ],
          "outputs": {
            "eventhubNamespaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.EventHub/namespaces', parameters('eventhubnamespaceName'))]"
            }
          }
        }
      }
    },
    {
      "condition": "[parameters('enableStreamAnalytics')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "streamanalytics001",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tagsJoined')]"
          },
          "eventhubNamespaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'eventhubNamespace001'), '2020-10-01').outputs.eventhubNamespaceId.value]"
          },
          "sqlServerId": {
            "value": "[if(parameters('enableSqlServer'), reference(resourceId('Microsoft.Resources/deployments', 'sql001'), '2020-10-01').outputs.sqlserverId.value, '')]"
          },
          "storageAccountId": {
            "value": "[resourceId(variables('streamanalyticsDefaultStorageAccountSubscriptionId'), variables('streamanalyticsDefaultStorageAccountResourceGroupName'), 'Microsoft.Storage/storageAccounts', variables('streamanalyticsDefaultStorageAccountName'))]"
          },
          "streamanalyticsclusterName": {
            "value": "[variables('streamanalyticscluster001Name')]"
          },
          "streamanalyticsclusterSkuCapacity": {
            "value": 36
          },
          "streamanalyticsName": {
            "value": "[variables('streamanalytics001Name')]"
          },
          "streamanalyticsjobSkuCapacity": {
            "value": 1
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.12.40.16777",
              "templateHash": "4961041212754097067"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "streamanalyticsclusterName": {
              "type": "string"
            },
            "streamanalyticsName": {
              "type": "string"
            },
            "streamanalyticsclusterSkuCapacity": {
              "type": "int",
              "defaultValue": 36,
              "maxValue": 216,
              "minValue": 36
            },
            "streamanalyticsjobSkuCapacity": {
              "type": "int",
              "defaultValue": 1,
              "allowedValues": [
                1,
                3,
                6,
                12,
                18,
                24,
                30,
                36,
                42,
                48
              ]
            },
            "storageAccountId": {
              "type": "string",
              "defaultValue": ""
            },
            "sqlServerId": {
              "type": "string",
              "defaultValue": ""
            },
            "eventhubNamespaceId": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "variables": {
            "storageAccountName": "[if(greaterOrEquals(length(split(parameters('storageAccountId'), '/')), 9), last(split(parameters('storageAccountId'), '/')), 'incorrectSegmentLength')]",
            "sqlServerName": "[if(greaterOrEquals(length(split(parameters('sqlServerId'), '/')), 9), last(split(parameters('sqlServerId'), '/')), 'incorrectSegmentLength')]",
            "eventhubNamespaceName": "[if(greaterOrEquals(length(split(parameters('eventhubNamespaceId'), '/')), 9), last(split(parameters('eventhubNamespaceId'), '/')), 'incorrectSegmentLength')]",
            "streamanalyticsclusterManagedPrivateEndpointNameStorageAccount": "[format('{0}-private-endpoint', variables('storageAccountName'))]",
            "streamanalyticsclusterManagedPrivateEndpointNameSqlServer": "[format('{0}-private-endpoint', variables('sqlServerName'))]",
            "streamanalyticsclusterManagedPrivateEndpointNameEventhubNamespace": "[format('{0}-private-endpoint', variables('eventhubNamespaceName'))]",
            "requestMessage": "[format('Private Endpoint for Stream Analytics Cluster {0}', parameters('streamanalyticsclusterName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.StreamAnalytics/clusters",
              "apiVersion": "2020-03-01",
              "name": "[parameters('streamanalyticsclusterName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Default",
                "capacity": "[parameters('streamanalyticsclusterSkuCapacity')]"
              },
              "properties": {}
            },
            {
              "condition": "[not(empty(parameters('storageAccountId')))]",
              "type": "Microsoft.StreamAnalytics/clusters/privateEndpoints",
              "apiVersion": "2020-03-01",
              "name": "[format('{0}/{1}', parameters('streamanalyticsclusterName'), variables('streamanalyticsclusterManagedPrivateEndpointNameStorageAccount'))]",
              "properties": {
                "manualPrivateLinkServiceConnections": [
                  {
                    "properties": {
                      "privateLinkServiceId": "[parameters('storageAccountId')]",
                      "groupIds": [
                        "blob"
                      ],
                      "privateLinkServiceConnectionState": {},
                      "requestMessage": "[variables('requestMessage')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.StreamAnalytics/clusters', parameters('streamanalyticsclusterName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('sqlServerId')))]",
              "type": "Microsoft.StreamAnalytics/clusters/privateEndpoints",
              "apiVersion": "2020-03-01",
              "name": "[format('{0}/{1}', parameters('streamanalyticsclusterName'), variables('streamanalyticsclusterManagedPrivateEndpointNameSqlServer'))]",
              "properties": {
                "manualPrivateLinkServiceConnections": [
                  {
                    "properties": {
                      "privateLinkServiceId": "[parameters('sqlServerId')]",
                      "groupIds": [
                        "sqlServer"
                      ],
                      "privateLinkServiceConnectionState": {},
                      "requestMessage": "[variables('requestMessage')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.StreamAnalytics/clusters', parameters('streamanalyticsclusterName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('eventhubNamespaceId')))]",
              "type": "Microsoft.StreamAnalytics/clusters/privateEndpoints",
              "apiVersion": "2020-03-01",
              "name": "[format('{0}/{1}', parameters('streamanalyticsclusterName'), variables('streamanalyticsclusterManagedPrivateEndpointNameEventhubNamespace'))]",
              "properties": {
                "manualPrivateLinkServiceConnections": [
                  {
                    "properties": {
                      "privateLinkServiceId": "[parameters('eventhubNamespaceId')]",
                      "groupIds": [
                        "namespace"
                      ],
                      "privateLinkServiceConnectionState": {},
                      "requestMessage": "[variables('requestMessage')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.StreamAnalytics/clusters', parameters('streamanalyticsclusterName'))]"
              ]
            },
            {
              "type": "Microsoft.StreamAnalytics/streamingjobs",
              "apiVersion": "2020-03-01",
              "name": "[parameters('streamanalyticsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "cluster": {
                  "id": "[resourceId('Microsoft.StreamAnalytics/clusters', parameters('streamanalyticsclusterName'))]"
                },
                "compatibilityLevel": "1.0",
                "dataLocale": "en-US",
                "eventsLateArrivalMaxDelayInSeconds": 5,
                "eventsOutOfOrderMaxDelayInSeconds": 0,
                "eventsOutOfOrderPolicy": "Adjust",
                "functions": [],
                "inputs": [],
                "outputs": [],
                "jobType": "Cloud",
                "outputErrorPolicy": "Stop",
                "sku": {
                  "name": "Standard"
                },
                "transformation": {
                  "name": "transformation",
                  "properties": {
                    "streamingUnits": "[parameters('streamanalyticsjobSkuCapacity')]",
                    "query": "SELECT\r\n    *\r\nINTO\r\n    [YourOutputAlias]\r\nFROM\r\n    [YourInputAlias]"
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.StreamAnalytics/clusters', parameters('streamanalyticsclusterName'))]"
              ]
            }
          ],
          "outputs": {
            "streamanalyticsjob001Id": {
              "type": "string",
              "value": "[resourceId('Microsoft.StreamAnalytics/streamingjobs', parameters('streamanalyticsName'))]"
            },
            "streamanalyticsjob001Name": {
              "type": "string",
              "value": "[parameters('streamanalyticsName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'eventhubNamespace001')]",
        "[resourceId('Microsoft.Resources/deployments', 'sql001')]"
      ]
    },
    {
      "condition": "[and(parameters('enableStreamAnalytics'), parameters('enableRoleAssignments'))]",
      "copy": {
        "name": "deploymentDelay",
        "count": "[length(range(0, 20))]",
        "mode": "serial",
        "batchSize": 1
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('delay-{0}', range(0, 20)[copyIndex()])]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "deploymentDelayIndex": {
            "value": "[range(0, 20)[copyIndex()]]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.12.40.16777",
              "templateHash": "9261396028486652289"
            }
          },
          "parameters": {
            "deploymentDelayIndex": {
              "type": "int"
            }
          },
          "resources": [],
          "outputs": {
            "deploymentDelayIndex": {
              "type": "int",
              "value": "[parameters('deploymentDelayIndex')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'streamanalytics001')]"
      ]
    },
    {
      "condition": "[and(parameters('enableStreamAnalytics'), parameters('enableRoleAssignments'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "streamanalytics001RoleAssignmentStorage",
      "subscriptionId": "[variables('streamanalyticsDefaultStorageAccountSubscriptionId')]",
      "resourceGroup": "[variables('streamanalyticsDefaultStorageAccountResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountFileSystemId": {
            "value": "[parameters('streamanalyticsDefaultStorageAccountFileSystemId')]"
          },
          "streamanalyticsjobId": {
            "value": "[if(parameters('enableStreamAnalytics'), reference(resourceId('Microsoft.Resources/deployments', 'streamanalytics001'), '2020-10-01').outputs.streamanalyticsjob001Id.value, '')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.12.40.16777",
              "templateHash": "457337203961297518"
            }
          },
          "parameters": {
            "storageAccountFileSystemId": {
              "type": "string"
            },
            "streamanalyticsjobId": {
              "type": "string"
            }
          },
          "variables": {
            "storageAccountFileSystemName": "[if(greaterOrEquals(length(split(parameters('storageAccountFileSystemId'), '/')), 13), last(split(parameters('storageAccountFileSystemId'), '/')), 'incorrectSegmentLength')]",
            "storageAccountName": "[if(greaterOrEquals(length(split(parameters('storageAccountFileSystemId'), '/')), 13), split(parameters('storageAccountFileSystemId'), '/')[8], 'incorrectSegmentLength')]",
            "streamanalyticsjobSubscriptionId": "[if(greaterOrEquals(length(split(parameters('streamanalyticsjobId'), '/')), 9), split(parameters('streamanalyticsjobId'), '/')[2], subscription().subscriptionId)]",
            "streamanalyticsjobResourceGroupName": "[if(greaterOrEquals(length(split(parameters('streamanalyticsjobId'), '/')), 9), split(parameters('streamanalyticsjobId'), '/')[4], resourceGroup().name)]",
            "streamanalyticsjobName": "[if(greaterOrEquals(length(split(parameters('streamanalyticsjobId'), '/')), 9), last(split(parameters('streamanalyticsjobId'), '/')), 'incorrectSegmentLength')]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}/blobServices/{1}/containers/{2}', split(format('{0}/default/{1}', variables('storageAccountName'), variables('storageAccountFileSystemName')), '/')[0], split(format('{0}/default/{1}', variables('storageAccountName'), variables('storageAccountFileSystemName')), '/')[1], split(format('{0}/default/{1}', variables('storageAccountName'), variables('storageAccountFileSystemName')), '/')[2])]",
              "name": "[guid(uniqueString(resourceId('Microsoft.Storage/storageAccounts/blobServices/containers', split(format('{0}/default/{1}', variables('storageAccountName'), variables('storageAccountFileSystemName')), '/')[0], split(format('{0}/default/{1}', variables('storageAccountName'), variables('storageAccountFileSystemName')), '/')[1], split(format('{0}/default/{1}', variables('storageAccountName'), variables('storageAccountFileSystemName')), '/')[2]), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('streamanalyticsjobSubscriptionId'), variables('streamanalyticsjobResourceGroupName')), 'Microsoft.StreamAnalytics/streamingjobs', variables('streamanalyticsjobName'))))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                "principalId": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('streamanalyticsjobSubscriptionId'), variables('streamanalyticsjobResourceGroupName')), 'Microsoft.StreamAnalytics/streamingjobs', variables('streamanalyticsjobName')), '2017-04-01-preview', 'full').identity.principalId]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "deploymentDelay",
        "[resourceId('Microsoft.Resources/deployments', 'streamanalytics001')]"
      ]
    },
    {
      "condition": "[parameters('enableMonitoring')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "logAnalytics001",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tagsJoined')]"
          },
          "logAnalyticsName": {
            "value": "[variables('logAnalytics001Name')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.12.40.16777",
              "templateHash": "14722009268800272701"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "logAnalyticsName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2020-10-01",
              "name": "[parameters('logAnalyticsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "features": {},
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled",
                "retentionInDays": 120,
                "sku": {
                  "name": "PerGB2018"
                }
              }
            }
          ],
          "outputs": {
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "value": "[parameters('logAnalyticsName')]"
            }
          }
        }
      }
    },
    {
      "condition": "[and(not(empty(parameters('dataProductTeamEmail'))), parameters('enableMonitoring'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "alerts",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "dataEmailActionGroup": {
            "value": "[variables('dataEmailActionGroup')]"
          },
          "dataProductTeamEmail": {
            "value": "[parameters('dataProductTeamEmail')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "synapsePipelineFailedAlertName": {
            "value": "[variables('synapsePipelineFailedAlertName')]"
          },
          "synapseScope": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'synapse001'), '2020-10-01').outputs.synapseId.value]"
          },
          "iothubFailedAlertName": {
            "value": "[variables('iothubFailedAlertName')]"
          },
          "iothubScope": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'iothub001'), '2020-10-01').outputs.iothubId.value]"
          },
          "eventhubnamespaceFailedAlertName": {
            "value": "[variables('eventhubnamespaceFailedAlertName')]"
          },
          "eventhubnamespaceScope": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'eventhubNamespace001'), '2020-10-01').outputs.eventhubNamespaceId.value]"
          },
          "streamanalyticsFailedAlertName": {
            "value": "[variables('streamanalyticsFailedAlertName')]"
          },
          "streamanalyticsScope": {
            "value": "[if(parameters('enableStreamAnalytics'), reference(resourceId('Microsoft.Resources/deployments', 'streamanalytics001'), '2020-10-01').outputs.streamanalyticsjob001Id.value, '')]"
          },
          "tags": {
            "value": "[variables('tagsJoined')]"
          },
          "enableStreamAnalytics": {
            "value": "[parameters('enableStreamAnalytics')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.12.40.16777",
              "templateHash": "3381918841558833257"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "synapsePipelineFailedAlertName": {
              "type": "string"
            },
            "synapseScope": {
              "type": "string"
            },
            "iothubFailedAlertName": {
              "type": "string"
            },
            "iothubScope": {
              "type": "string"
            },
            "eventhubnamespaceFailedAlertName": {
              "type": "string"
            },
            "eventhubnamespaceScope": {
              "type": "string"
            },
            "streamanalyticsFailedAlertName": {
              "type": "string"
            },
            "streamanalyticsScope": {
              "type": "string"
            },
            "dataEmailActionGroup": {
              "type": "string"
            },
            "dataProductTeamEmail": {
              "type": "string"
            },
            "enableStreamAnalytics": {
              "type": "bool"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/actionGroups",
              "apiVersion": "2021-09-01",
              "name": "[parameters('dataEmailActionGroup')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "groupShortName": "emailgroup",
                "emailReceivers": [
                  {
                    "emailAddress": "[parameters('dataProductTeamEmail')]",
                    "name": "emailaction",
                    "useCommonAlertSchema": true
                  }
                ],
                "enabled": true
              }
            },
            {
              "type": "Microsoft.Insights/metricAlerts",
              "apiVersion": "2018-03-01",
              "name": "[parameters('synapsePipelineFailedAlertName')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "actions": [
                  {
                    "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', parameters('dataEmailActionGroup'))]"
                  }
                ],
                "autoMitigate": false,
                "criteria": {
                  "odata.type": "Microsoft.Azure.Monitor.MultipleResourceMultipleMetricCriteria",
                  "allOf": [
                    {
                      "threshold": 1,
                      "name": "Metric1",
                      "metricNamespace": "Microsoft.Synapse/workspaces",
                      "metricName": "IntegrationPipelineRunsEnded",
                      "operator": "GreaterThanOrEqual",
                      "timeAggregation": "Total",
                      "criterionType": "StaticThresholdCriterion",
                      "dimensions": [
                        {
                          "name": "Result",
                          "operator": "Include",
                          "values": [
                            "Failed"
                          ]
                        }
                      ]
                    }
                  ]
                },
                "description": "Synapse pipeline failed",
                "enabled": true,
                "evaluationFrequency": "PT1M",
                "scopes": [
                  "[parameters('synapseScope')]"
                ],
                "severity": 1,
                "targetResourceRegion": "[parameters('location')]",
                "targetResourceType": "Microsoft.Synapse/workspaces",
                "windowSize": "PT5M"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/actionGroups', parameters('dataEmailActionGroup'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/metricAlerts",
              "apiVersion": "2018-03-01",
              "name": "[parameters('iothubFailedAlertName')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "actions": [
                  {
                    "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', parameters('dataEmailActionGroup'))]"
                  }
                ],
                "autoMitigate": false,
                "criteria": {
                  "odata.type": "Microsoft.Azure.Monitor.MultipleResourceMultipleMetricCriteria",
                  "allOf": [
                    {
                      "threshold": 1,
                      "name": "Metric1",
                      "metricNamespace": "Microsoft.Devices/IotHubs",
                      "metricName": "c2d.methods.failure",
                      "operator": "GreaterThanOrEqual",
                      "timeAggregation": "Total",
                      "criterionType": "StaticThresholdCriterion"
                    }
                  ]
                },
                "description": "Direct method call failed",
                "enabled": true,
                "evaluationFrequency": "PT1M",
                "scopes": [
                  "[parameters('iothubScope')]"
                ],
                "severity": 1,
                "targetResourceRegion": "[parameters('location')]",
                "targetResourceType": "Microsoft.Devices/IotHubs",
                "windowSize": "PT5M"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/actionGroups', parameters('dataEmailActionGroup'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/metricAlerts",
              "apiVersion": "2018-03-01",
              "name": "[parameters('eventhubnamespaceFailedAlertName')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "actions": [
                  {
                    "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', parameters('dataEmailActionGroup'))]"
                  }
                ],
                "autoMitigate": false,
                "criteria": {
                  "odata.type": "Microsoft.Azure.Monitor.MultipleResourceMultipleMetricCriteria",
                  "allOf": [
                    {
                      "threshold": 1,
                      "name": "Metric1",
                      "metricNamespace": "Microsoft.EventHub/namespaces",
                      "metricName": "ServerErrors",
                      "operator": "GreaterThanOrEqual",
                      "timeAggregation": "Total",
                      "criterionType": "StaticThresholdCriterion"
                    }
                  ]
                },
                "description": "Number of unprocessed requests because of error",
                "enabled": true,
                "evaluationFrequency": "PT1M",
                "scopes": [
                  "[parameters('eventhubnamespaceScope')]"
                ],
                "severity": 1,
                "targetResourceRegion": "[parameters('location')]",
                "targetResourceType": "Microsoft.EventHub/namespaces",
                "windowSize": "PT5M"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/actionGroups', parameters('dataEmailActionGroup'))]"
              ]
            },
            {
              "condition": "[parameters('enableStreamAnalytics')]",
              "type": "Microsoft.Insights/metricAlerts",
              "apiVersion": "2018-03-01",
              "name": "[parameters('streamanalyticsFailedAlertName')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "actions": [
                  {
                    "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', parameters('dataEmailActionGroup'))]"
                  }
                ],
                "autoMitigate": false,
                "criteria": {
                  "odata.type": "Microsoft.Azure.Monitor.MultipleResourceMultipleMetricCriteria",
                  "allOf": [
                    {
                      "threshold": 1,
                      "name": "Metric1",
                      "metricNamespace": "Microsoft.StreamAnalytics/streamingjobs",
                      "metricName": "Errors",
                      "operator": "GreaterThanOrEqual",
                      "timeAggregation": "Total",
                      "criterionType": "StaticThresholdCriterion"
                    }
                  ]
                },
                "description": "Number of query processing errors",
                "enabled": true,
                "evaluationFrequency": "PT1M",
                "scopes": [
                  "[parameters('streamanalyticsScope')]"
                ],
                "severity": 1,
                "targetResourceRegion": "[parameters('location')]",
                "targetResourceType": "Microsoft.StreamAnalytics/streamingjobs",
                "windowSize": "PT5M"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/actionGroups', parameters('dataEmailActionGroup'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'eventhubNamespace001')]",
        "[resourceId('Microsoft.Resources/deployments', 'iothub001')]",
        "[resourceId('Microsoft.Resources/deployments', 'streamanalytics001')]",
        "[resourceId('Microsoft.Resources/deployments', 'synapse001')]"
      ]
    },
    {
      "condition": "[parameters('enableMonitoring')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "dashboard",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "dashboardName": {
            "value": "[variables('dashboardName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "synapse001Name": {
            "value": "[variables('synapse001Name')]"
          },
          "synapseScope": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'synapse001'), '2020-10-01').outputs.synapseId.value]"
          },
          "cosmosdb001Name": {
            "value": "[if(parameters('enableCosmos'), reference(resourceId('Microsoft.Resources/deployments', 'cosmos001'), '2020-10-01').outputs.cosmosdbName.value, '')]"
          },
          "cosmosdbScope": {
            "value": "[if(parameters('enableCosmos'), reference(resourceId('Microsoft.Resources/deployments', 'cosmos001'), '2020-10-01').outputs.cosmosdbId.value, '')]"
          },
          "iothub001Name": {
            "value": "[variables('iothub001Name')]"
          },
          "iothubScope": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'iothub001'), '2020-10-01').outputs.iothubId.value]"
          },
          "eventhubnamespace001Name": {
            "value": "[variables('eventhubNamespace001Name')]"
          },
          "eventhubnamespaceScope": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'eventhubNamespace001'), '2020-10-01').outputs.eventhubNamespaceId.value]"
          },
          "streamanalytics001Name": {
            "value": "[if(parameters('enableStreamAnalytics'), reference(resourceId('Microsoft.Resources/deployments', 'streamanalytics001'), '2020-10-01').outputs.streamanalyticsjob001Name.value, '')]"
          },
          "streamanalyticsScope": {
            "value": "[if(parameters('enableStreamAnalytics'), reference(resourceId('Microsoft.Resources/deployments', 'streamanalytics001'), '2020-10-01').outputs.streamanalyticsjob001Id.value, '')]"
          },
          "tags": {
            "value": "[variables('tagsJoined')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.12.40.16777",
              "templateHash": "5319113977325430597"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "dashboardName": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "synapseScope": {
              "type": "string"
            },
            "synapse001Name": {
              "type": "string"
            },
            "cosmosdbScope": {
              "type": "string"
            },
            "cosmosdb001Name": {
              "type": "string"
            },
            "iothubScope": {
              "type": "string"
            },
            "iothub001Name": {
              "type": "string"
            },
            "eventhubnamespaceScope": {
              "type": "string"
            },
            "eventhubnamespace001Name": {
              "type": "string"
            },
            "streamanalyticsScope": {
              "type": "string"
            },
            "streamanalytics001Name": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Portal/dashboards",
              "apiVersion": "2020-09-01-preview",
              "name": "[format('{0}-synapse', parameters('dashboardName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "lenses": [
                  {
                    "order": 0,
                    "parts": [
                      {
                        "position": {
                          "x": 0,
                          "y": 0,
                          "rowSpan": 4,
                          "colSpan": 6
                        },
                        "metadata": {
                          "inputs": [
                            {
                              "name": "options",
                              "isOptional": true
                            },
                            {
                              "name": "sharedTimeRange",
                              "isOptional": true
                            }
                          ],
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "settings": {
                            "content": {
                              "options": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('synapseScope')]"
                                      },
                                      "name": "IntegrationPipelineRunsEnded",
                                      "aggregationType": 1,
                                      "namespace": "microsoft.synapse/workspaces",
                                      "metricVisualization": {
                                        "displayName": "Pipeline runs ended",
                                        "resourceDisplayName": "[parameters('synapse001Name')]"
                                      }
                                    }
                                  ],
                                  "title": "[format('Sum Pipeline runs ended for {0}', parameters('synapse001Name'))]",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    },
                                    "disablePinning": true
                                  }
                                }
                              }
                            }
                          }
                        }
                      },
                      {
                        "position": {
                          "x": 6,
                          "y": 0,
                          "rowSpan": 4,
                          "colSpan": 6
                        },
                        "metadata": {
                          "inputs": [
                            {
                              "name": "options",
                              "isOptional": true
                            },
                            {
                              "name": "",
                              "isOptional": true
                            }
                          ],
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "settings": {
                            "content": {
                              "options": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('synapseScope')]"
                                      },
                                      "name": "IntegrationActivityRunsEnded",
                                      "aggregationType": 1,
                                      "namespace": "microsoft.synapse/workspaces",
                                      "metricVisualization": {
                                        "displayName": "Activity runs ended",
                                        "resourceDisplayName": "[parameters('synapse001Name')]"
                                      }
                                    }
                                  ],
                                  "title": "[format('Sum of Activity runs ended for {0}', parameters('synapse001Name'))]",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    },
                                    "disablePinning": true
                                  }
                                }
                              }
                            }
                          }
                        }
                      },
                      {
                        "position": {
                          "x": 0,
                          "y": 4,
                          "colSpan": 6,
                          "rowSpan": 4
                        },
                        "metadata": {
                          "inputs": [
                            {
                              "name": "options",
                              "isOptional": true
                            },
                            {
                              "name": "sharedTimeRange",
                              "isOptional": true
                            }
                          ],
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "settings": {
                            "content": {
                              "options": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('cosmosdbScope')]"
                                      },
                                      "name": "ServerSideLatency",
                                      "aggregationType": 4,
                                      "namespace": "Microsoft.DocumentDB/databaseAccounts",
                                      "metricVisualization": {
                                        "displayName": "Server Side Latency",
                                        "resourceDisplayName": "[parameters('cosmosdb001Name')]"
                                      }
                                    }
                                  ],
                                  "title": "[format('Avg Server Side Latency for {0}', parameters('cosmosdb001Name'))]",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    },
                                    "disablePinning": true
                                  }
                                }
                              }
                            }
                          }
                        }
                      },
                      {
                        "position": {
                          "x": 6,
                          "y": 4,
                          "colSpan": 6,
                          "rowSpan": 4
                        },
                        "metadata": {
                          "inputs": [
                            {
                              "name": "options",
                              "isOptional": true
                            },
                            {
                              "name": "sharedTimeRange",
                              "isOptional": true
                            }
                          ],
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "settings": {
                            "content": {
                              "options": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('iothubScope')]"
                                      },
                                      "name": "jobs.failed",
                                      "aggregationType": 1,
                                      "namespace": "Microsoft.Devices/IotHubs",
                                      "metricVisualization": {
                                        "displayName": "Failed jobs",
                                        "resourceDisplayName": "[parameters('iothub001Name')]"
                                      }
                                    }
                                  ],
                                  "title": "[format('Sum Failed jobs for {0}', parameters('iothub001Name'))]",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    },
                                    "disablePinning": true
                                  }
                                }
                              }
                            }
                          }
                        }
                      },
                      {
                        "position": {
                          "x": 0,
                          "y": 8,
                          "colSpan": 6,
                          "rowSpan": 4
                        },
                        "metadata": {
                          "inputs": [
                            {
                              "name": "options",
                              "isOptional": true
                            },
                            {
                              "name": "sharedTimeRange",
                              "isOptional": true
                            }
                          ],
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "settings": {
                            "content": {
                              "options": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('eventhubnamespaceScope')]"
                                      },
                                      "name": "ServerErrors",
                                      "aggregationType": 1,
                                      "namespace": "Microsoft.EventHub/namespaces",
                                      "metricVisualization": {
                                        "displayName": "Server Errors.",
                                        "resourceDisplayName": "[parameters('eventhubnamespace001Name')]"
                                      }
                                    }
                                  ],
                                  "title": "[format('Sum Server Errors for {0}', parameters('eventhubnamespace001Name'))]",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    },
                                    "disablePinning": true
                                  }
                                }
                              }
                            }
                          }
                        }
                      },
                      {
                        "position": {
                          "x": 6,
                          "y": 8,
                          "colSpan": 6,
                          "rowSpan": 4
                        },
                        "metadata": {
                          "inputs": [
                            {
                              "name": "options",
                              "isOptional": true
                            },
                            {
                              "name": "sharedTimeRange",
                              "isOptional": true
                            }
                          ],
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "settings": {
                            "content": {
                              "options": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('streamanalyticsScope')]"
                                      },
                                      "name": "Errors",
                                      "aggregationType": 1,
                                      "namespace": "microsoft.streamanalytics/streamingjobs",
                                      "metricVisualization": {
                                        "displayName": "Runtime Errors",
                                        "resourceDisplayName": "[parameters('streamanalytics001Name')]"
                                      }
                                    }
                                  ],
                                  "title": "[format('Sum Runtime Errors for {0}', parameters('streamanalytics001Name'))]",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    },
                                    "disablePinning": true
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    ]
                  }
                ],
                "metadata": {
                  "model": {}
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'cosmos001')]",
        "[resourceId('Microsoft.Resources/deployments', 'eventhubNamespace001')]",
        "[resourceId('Microsoft.Resources/deployments', 'iothub001')]",
        "[resourceId('Microsoft.Resources/deployments', 'streamanalytics001')]",
        "[resourceId('Microsoft.Resources/deployments', 'synapse001')]"
      ]
    },
    {
      "condition": "[parameters('enableMonitoring')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "diagnosticSettings",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "logAnalyticsName": {
            "value": "[if(parameters('enableMonitoring'), reference(resourceId('Microsoft.Resources/deployments', 'logAnalytics001'), '2020-10-01').outputs.logAnalyticsWorkspaceName.value, '')]"
          },
          "synapseName": {
            "value": "[variables('synapse001Name')]"
          },
          "synapseSqlPools": {
            "value": [
              "[if(parameters('enableSqlPool'), reference(resourceId('Microsoft.Resources/deployments', 'synapse001'), '2020-10-01').outputs.synapseSqlPool001Name.value, null())]"
            ]
          },
          "synapseSparkPools": {
            "value": [
              "[reference(resourceId('Microsoft.Resources/deployments', 'synapse001'), '2020-10-01').outputs.synapseBigDataPool001Name.value]"
            ]
          },
          "cosmosdbName": {
            "value": "[if(parameters('enableCosmos'), reference(resourceId('Microsoft.Resources/deployments', 'cosmos001'), '2020-10-01').outputs.cosmosdbName.value, '')]"
          },
          "iothubName": {
            "value": "[variables('iothub001Name')]"
          },
          "sqlserverName": {
            "value": "[variables('sql001Name')]"
          },
          "eventhubnamespaceName": {
            "value": "[variables('eventhubNamespace001Name')]"
          },
          "streamanalyticsName": {
            "value": "[if(parameters('enableStreamAnalytics'), reference(resourceId('Microsoft.Resources/deployments', 'streamanalytics001'), '2020-10-01').outputs.streamanalyticsjob001Name.value, '')]"
          },
          "enableCosmos": {
            "value": "[parameters('enableCosmos')]"
          },
          "enableStreamAnalytics": {
            "value": "[parameters('enableStreamAnalytics')]"
          },
          "database001Name": {
            "value": "[if(parameters('enableSqlServer'), reference(resourceId('Microsoft.Resources/deployments', 'sql001'), '2020-10-01').outputs.sqlserverDatabaseName.value, '')]"
          },
          "enableSqlPool": {
            "value": "[parameters('enableSqlPool')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.12.40.16777",
              "templateHash": "13746696680236980375"
            }
          },
          "parameters": {
            "logAnalyticsName": {
              "type": "string"
            },
            "synapseName": {
              "type": "string"
            },
            "cosmosdbName": {
              "type": "string"
            },
            "iothubName": {
              "type": "string"
            },
            "sqlserverName": {
              "type": "string"
            },
            "eventhubnamespaceName": {
              "type": "string"
            },
            "streamanalyticsName": {
              "type": "string"
            },
            "synapseSqlPools": {
              "type": "array"
            },
            "synapseSparkPools": {
              "type": "array"
            },
            "enableCosmos": {
              "type": "bool"
            },
            "enableStreamAnalytics": {
              "type": "bool"
            },
            "database001Name": {
              "type": "string"
            },
            "enableSqlPool": {
              "type": "bool"
            }
          },
          "variables": {
            "synapseSqlPoolsCount": "[length(parameters('synapseSqlPools'))]",
            "synapseSparkPoolCount": "[length(parameters('synapseSparkPools'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Synapse/workspaces/{0}', parameters('synapseName'))]",
              "name": "[format('diagnostic-{0}', parameters('synapseName'))]",
              "properties": {
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]",
                "logs": [
                  {
                    "category": "SynapseRbacOperations",
                    "enabled": true
                  },
                  {
                    "category": "GatewayApiRequests",
                    "enabled": true
                  },
                  {
                    "category": "BuiltinSqlReqsEnded",
                    "enabled": true
                  },
                  {
                    "category": "IntegrationPipelineRuns",
                    "enabled": true
                  },
                  {
                    "category": "IntegrationActivityRuns",
                    "enabled": true
                  },
                  {
                    "category": "IntegrationTriggerRuns",
                    "enabled": true
                  }
                ]
              }
            },
            {
              "condition": "[parameters('enableSqlPool')]",
              "copy": {
                "name": "diagnosticSetting002",
                "count": "[length(range(0, variables('synapseSqlPoolsCount')))]"
              },
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Synapse/workspaces/{0}/sqlPools/{1}', parameters('synapseName'), parameters('synapseSqlPools')[range(0, variables('synapseSqlPoolsCount'))[copyIndex()]])]",
              "name": "[format('diagnostic-{0}-{1}', parameters('synapseName'), parameters('synapseSqlPools')[range(0, variables('synapseSqlPoolsCount'))[copyIndex()]])]",
              "properties": {
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]",
                "logs": [
                  {
                    "category": "SqlRequests",
                    "enabled": true
                  },
                  {
                    "category": "RequestSteps",
                    "enabled": true
                  },
                  {
                    "category": "ExecRequests",
                    "enabled": true
                  },
                  {
                    "category": "DmsWorkers",
                    "enabled": true
                  },
                  {
                    "category": "Waits",
                    "enabled": true
                  }
                ]
              }
            },
            {
              "copy": {
                "name": "diagnosticSetting003",
                "count": "[length(range(0, variables('synapseSparkPoolCount')))]"
              },
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Synapse/workspaces/{0}/bigDataPools/{1}', parameters('synapseName'), parameters('synapseSparkPools')[range(0, variables('synapseSparkPoolCount'))[copyIndex()]])]",
              "name": "[format('diagnostic-{0}-{1}', parameters('synapseName'), parameters('synapseSparkPools')[range(0, variables('synapseSparkPoolCount'))[copyIndex()]])]",
              "properties": {
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]",
                "logs": [
                  {
                    "category": "BigDataPoolAppsEnded",
                    "enabled": true
                  }
                ]
              }
            },
            {
              "condition": "[parameters('enableCosmos')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.DocumentDB/databaseAccounts/{0}', parameters('cosmosdbName'))]",
              "name": "[format('diagnostic-{0}', parameters('cosmosdbName'))]",
              "properties": {
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]",
                "logs": [
                  {
                    "category": "DataPlaneRequests",
                    "enabled": true
                  },
                  {
                    "category": "QueryRuntimeStatistics",
                    "enabled": true
                  },
                  {
                    "category": "PartitionKeyStatistics",
                    "enabled": true
                  },
                  {
                    "category": "PartitionKeyRUConsumption",
                    "enabled": true
                  },
                  {
                    "category": "ControlPlaneRequests",
                    "enabled": true
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Devices/IotHubs/{0}', parameters('iothubName'))]",
              "name": "[format('diagnostic-{0}', parameters('iothubName'))]",
              "properties": {
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]",
                "logs": [
                  {
                    "category": "Connections",
                    "enabled": true
                  },
                  {
                    "category": "DeviceTelemetry",
                    "enabled": true
                  },
                  {
                    "category": "C2DCommands",
                    "enabled": true
                  },
                  {
                    "category": "DeviceIdentityOperations",
                    "enabled": true
                  },
                  {
                    "category": "FileUploadOperations",
                    "enabled": true
                  },
                  {
                    "category": "Routes",
                    "enabled": true
                  },
                  {
                    "category": "D2CTwinOperations",
                    "enabled": true
                  },
                  {
                    "category": "C2DTwinOperations",
                    "enabled": true
                  },
                  {
                    "category": "TwinQueries",
                    "enabled": true
                  },
                  {
                    "category": "JobsOperations",
                    "enabled": true
                  },
                  {
                    "category": "DirectMethods",
                    "enabled": true
                  },
                  {
                    "category": "DistributedTracing",
                    "enabled": true
                  },
                  {
                    "category": "Configurations",
                    "enabled": true
                  },
                  {
                    "category": "DeviceStreams",
                    "enabled": true
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.EventHub/namespaces/{0}', parameters('eventhubnamespaceName'))]",
              "name": "[format('diagnostic-{0}', parameters('eventhubnamespaceName'))]",
              "properties": {
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]",
                "logs": [
                  {
                    "category": "ArchiveLogs",
                    "enabled": true
                  },
                  {
                    "category": "OperationalLogs",
                    "enabled": true
                  },
                  {
                    "category": "AutoScaleLogs",
                    "enabled": true
                  },
                  {
                    "category": "KafkaCoordinatorLogs",
                    "enabled": true
                  },
                  {
                    "category": "KafkaUserErrorLogs",
                    "enabled": true
                  },
                  {
                    "category": "EventHubVNetConnectionEvent",
                    "enabled": true
                  },
                  {
                    "category": "CustomerManagedKeyUserLogs",
                    "enabled": true
                  },
                  {
                    "category": "RuntimeAuditLogs",
                    "enabled": true
                  },
                  {
                    "category": "ApplicationMetricsLogs",
                    "enabled": true
                  }
                ]
              }
            },
            {
              "condition": "[parameters('enableStreamAnalytics')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.StreamAnalytics/streamingjobs/{0}', parameters('streamanalyticsName'))]",
              "name": "[format('diagnostic-{0}', parameters('streamanalyticsName'))]",
              "properties": {
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]",
                "logs": [
                  {
                    "category": "Execution",
                    "enabled": true
                  },
                  {
                    "category": "Authoring",
                    "enabled": true
                  }
                ]
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'cosmos001')]",
        "[resourceId('Microsoft.Resources/deployments', 'logAnalytics001')]",
        "[resourceId('Microsoft.Resources/deployments', 'sql001')]",
        "[resourceId('Microsoft.Resources/deployments', 'streamanalytics001')]",
        "[resourceId('Microsoft.Resources/deployments', 'synapse001')]"
      ]
    }
  ]
}